{% extends 'layouts/base.html' %}

{% block title %} QuickSight Analytics 
  
{% endblock title %} 

{% block content %}
 <!-- [ Main Content ] start -->

<head>
  <title>QuickSight Analytics </title>
  <script src="https://ajax.googleapis.com/ajax/libs/jquery/3.5.1/jquery.min.js"></script>
</head>

<body>

// quick way to add jsx to website (for genai chatbot)
<script src="https://unpkg.com/babel-standalone@6/babel.min.js"></script>
  
// script for when page reloaded (whether quicksight dashboard request or genai prompt)
  <script>  
    // if window reloaded, add delayed sales forecast completion message
    if (window.performance) {
      console.info("window.performance works fine on this browser");
    }
    console.info(performance.navigation.type);
    if (performance.navigation.type == performance.navigation.TYPE_RELOAD) {
      console.info( "This page is reloaded" );

        setTimeout(
                                function() 
                                {
                                
                                  // if GenAI response received, then show the iframe
                                  if('{{ session["genai_resp"] }}' !== '') {
                                    $('#llm-out').show();
                                  } else {
                                    // do nothing
                                  }

                                  // if QS analytics response received, then show the iframe
                                  // if('{{ session["qs_url"] }}' !== '') {
                                  // // hide QuickSight analytics submit button after clicked
                                  // $("#qs_submit").hide();
                                  // //wait 2 secs then load this...
                                  // // $('#qs-container').append($('<iframe allowfullscreen src={{ session["qs_url"] }} style="position:absolute; border: none; overflow: hidden;"></iframe>'));
                                  // $('#qs-container').append($('<iframe src={{ session["qs_url"] }}></iframe>'));
                                  


                                  // } else {
                                  //   // do nothing
                                  // }
                                
                                  
                                }, 2000);

                                
                                
  
                                

    } else {
      console.info( "This page is not reloaded");
    }

</script> 

 
<!-- GENAI DIV -->
  <div class="pc-container">
    <div class="pc-content">
      <!-- [ breadcrumb ] start -->
      <div class="page-header">
        <div class="page-block">
          <div class="row align-items-center">
            <div class="col-md-12">
              <div class="page-header-title">
                <h5 class="m-b-10">LDFE Diagnostics Engine</h5>
              </div>
              <ul class="breadcrumb">
                <li class="breadcrumb-item"><a href="/">Home</a></li><br>
              </ul>
                

              </div>
          </div>
        </div>
      </div>
      <!-- [ breadcrumb ] end -->


      <!-- QUICKSIGHT DIV -->
      <!-- [ Main Content ] start -->
      <div class="row">
        
        <div class="col-sm-12">
          <div class="card">
            <div class="card-header">
              <h5>QuickSight Analytics</h5>
                <p id="empty_div"></p>
                  <!-- <button type="submit" id="qs_submit" name="qs_submit" >Load QuickSight Dashboard</button> -->
                  <button type="submit" id="qs_submit" name="qs_submit" class="btn large-modal" data-bs-toggle="modal" data-bs-target="#myModal" style="background-color:#d4e7f9; color: #111936">
                    Load QuickSight Dashboard
                  </button>

                    <p id="qs-load-msg"></p>
            <!-- <div allowfullscreen id="qs-container" ></div> -->

    </div>
  </div>
</div>


<!-- The Modal -->
<div class="modal" id="myModal">
  <div class="modal-dialog modal-fullscreen">
    <div class="modal-content">

<!-- Modal Header -->
<div class="modal-header" id="modal-head">
<!-- <h4 class="modal-title">Modal Heading</h4> -->
<button type="button" class="btn-close" data-bs-dismiss="modal"></button>
</div>

<!-- Modal body -->
<div class="modal-body" id="qs-container">
<!-- Modal body.. -->
  <iframe class="responsive-iframe" src="https://www.youtube.com/embed/tgbNymZ7vqY"></iframe> <!-- placeholder -->
</div>

<!-- Modal footer -->
<div class="modal-footer">
<button type="button" class="btn btn-danger" data-bs-dismiss="modal" style="background-color:#d4e7f9; color: #111936; border-color: #d4e7f9">Close</button>
</div>

              
            </div>
          </div>
        </div>
        

      <!-- INVOKE CHATBOT -->
      
      <div class="page-block">

        <div class="row align-items-center">

          <button type="submit" id="refresh_job_status" class="btn large-modal" style="background-color:#d4e7f9; color: #111936; width:150px; margin-left: 40px; margin-top: 10px;">Refresh job status</button>
          <p id="empty_div"></p>
          <p id="job_refresh_status" style="margin-left: 30px"></p>
            

          <div class="col-md-12">
              <iframe src="http://localhost:5173" 
              style="width:1200px; height:300px; border: 1px solid black;"></iframe>
          </div>
        </div>

      </div>



        
          </div>
        </div>
        <!-- [ Typography ] end -->
      </div>
      <!-- [ Main Content ] end -->
    </div>
  </div>
  <!-- [ Main Content ] end -->

  <script>  

    // only enable button actions when webpage ready
    $(document).ready(function(){


      // FIRST: LLM handling when llm button pressed
      $("#llm_submit").on('click', function(e){

      // show message
      document.getElementById("llm-query").innerHTML = "Querying RAG/LLM model...";
      document.getElementById("llm-out").innerHTML = ""; // clear any previous LLM responses


      // debug
      // alert(`LLM Prompt Submitted`); 

      var llmQu = $("#llm_qu").val();

      $.ajax({
              type: "GET",
              url: '/gen_ai',
              data: {target_qu: llmQu},
                          success: function (resp) {
                              // alert(`target_qu : {llm_qu}`);
                              //   alert(`target qu transferred to flask`); 
                                // $('#genai-iframe').show();

                                // remove message and reload page after graceful 10 secs
                                setTimeout(function(){
                                    document.getElementById("llm-query").innerHTML = '';
                                    // document.getElementById("llm-out").innerHTML = '{{ session["genai_resp"] }}';
                                    // $('#llm-out').show();
                                    window.location.reload();
                                }, 5000);
                              },
                              error: function (error) {
                                console.log(error);
                              }
                            })


            });
            

      // SECOND: QuickSight analytics handling when quicksight button pressed
      $("#qs_submit").on('click', function(e){
      
        

        // hide button after clicked
        $("#qs_submit").hide();

   
        // show message for a few secs
        document.getElementById("modal-head").innerHTML = 'QuickSight dashboard will load shortly...'
        setTimeout(function() {
          document.getElementById("modal-head").innerHTML = ''
        }, 5000); 

                  
            // $('#qs-dash-iframe').attr('src',
                    
          $.ajax({
                    type: "GET",
                    url: '/analytics',
                    data: {quicksight: 'yes'},
                                success: function (resp) {
                                      // $('#qs-dash-iframe').show();
                            

                                      // remove message and reload page after graceful 5 secs
                                      setTimeout(function(){
                                          document.getElementById("qs-load-msg").innerHTML = '';

                                          // $('#qs-container').append($('<?= file_get_contents("{{ session["qs_url"] }}"); ?>'));
                                          $('#qs-container').append($('<iframe class="responsive-iframe" src={{ session["qs_url"] }}"></iframe>'));
                                          // var src = $(this).attr('src').replace('https://www.youtube.com/embed/tgbNymZ7vqY','{{ session["qs_url"] }}'); 
                                          // $('iframe.responsive-iframe').attr('src', src);                                   

                                          // window.location.reload();
                                      }, 3000);
                                      
                                      

                                    },
                                    error: function (error) {
                                      console.log(error);
                                    }
                                  })
          
          });

      
      


      });


      $("#refresh_job_status").on('click', function(e){
 
        console.log('refresh job status clicked');
        document.getElementById('job_refresh_status').innerHTML = "refreshing...";

        $.ajax({
          type: "GET",
          url: '/refresh_job_status',
          success: function(resp){
            console.log('done');
            window.location.reload();
            }
        });


        });


      </script>
    
  

</body>

{% endblock content %}

</html>
